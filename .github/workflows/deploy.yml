name: Build and Deploy

on:
  push:
    branches: [ dev, main ]
  workflow_dispatch:

env:
  IMAGE_NAME: web3dozie/taskline
  REGISTRY: docker.io

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/dev' }}
            type=raw,value=stable,enable=${{ github.ref == 'refs/heads/main' }}
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./deployment/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE_NAME }}:buildcache,mode=max

  deploy:
    name: Deploy to Production
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VM (Blue-Green)
        run: |
          ssh -i ~/.ssh/id_ed25519 root@${{ secrets.VM_HOST }} << 'ENDSSH'
          set -e

          echo "=== Starting deployment ==="
          cd /opt/taskline

          # Run blue-green deployment
          ./deploy.sh

          echo "=== Deployment complete ==="
          ENDSSH

      - name: Update install scripts on VM
        run: |
          scp -i ~/.ssh/id_ed25519 install.sh install.ps1 root@${{ secrets.VM_HOST }}:/var/www/mytaskline/
          echo "âœ“ Install scripts updated"

      - name: Verify deployment
        run: |
          echo "Waiting 10s for app to stabilize..."
          sleep 10

          echo "Checking health endpoint..."
          curl -f https://mytaskline.app/nginx-health || {
            echo "âœ— Health check failed!"
            exit 1
          }

          echo "âœ“ Deployment verified!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ Deployment successful!"
            echo "Live at: https://mytaskline.app"
          else
            echo "âŒ Deployment failed!"
          fi
